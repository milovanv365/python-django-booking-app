{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap4 %}

{% block title %}
    Make a Reservation
{% endblock %}

{% block content %}
    <div class="reservation">
        <h1 class="my_title">Make a Reservation</h1>
        <div class="row text-center">
            <div class="col-md-3"></div>
            <div class="col-md-6">
                <img class="nursery-photo" src="{{ nursery.image.url }}" style="width: 100%">
                <h2 class="nursery-name">{{ nursery.name }}</h2>
                <h4 class="text-center">
                    Available Capacity:
                    <span class="js-available-stock"></span>
                </h4>
            </div>
            <div class="col-md-3"></div>
        </div>

        <div class="margin-top-main">
            {% if reservation_exist %}
            <div class="alert alert-warning alert-dismissible">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <strong>You already have the same reservation. Check your reservation history, please</strong>
            </div>
            {% endif %}
            <form enctype="multipart/form-data" method="post" onsubmit="return goNext()">
                {% csrf_token %}
                <input type="hidden" id="nursery_id" value="{{ nursery.id }}">
                <input type="hidden" name="period" id="period" value="">
                <input type="hidden" name="total_price" id="total_price" value="">
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-6 row">
                            <div class="col-md-4"><label class="">Date</label></div>
                            <div class="col-md-8">{% bootstrap_field form.start_date %}</div>
                        </div>
                        <div class="col-md-3 row">
                            <div class="col-md-6"><label class="">Start Time</label></div>
                            <div class="col-md-6">{% bootstrap_field form.start_time %}</div>
                        </div>
                        <div class="col-md-3 row">
                            <div class="col-md-6"><label class="">Hourly Plan</label></div>
                            <div class="col-md-6">{% bootstrap_field form.price_plan %}</div>
                        </div>
                    </div>
                </div>
                <div class="total-price-box clearfix">
                    <p class="price float-left"></p>
                    <p class="float-left money-signal">USD</p>
                </div>
                <div class="reservation-info">
                    <div class="row">
                        <div class="col-md-7 control-label">Your Name</div>
                        <div class="col-md-5">{% bootstrap_field form.name %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">Your Email</div>
                        <div class="col-md-5">{% bootstrap_field form.email %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">Age of your child</div>
                        <div class="col-md-5">{% bootstrap_field form.child_age %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">Number of child</div>
                        <div class="col-md-5">
                            {% bootstrap_field form.child_number %}
                            <div class="alert alert-danger alert-stock-exceed display-none">
                                <strong>Child number exceed available capacity ! </strong>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">If have an allergy, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.allergy %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">If have not received a vaccination, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.vaccination %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">If do not want a hospital in an emergency, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.illness %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">If do not have travel insurance, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.travel_insurance %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">If smart phone is not available while traveling, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.wifi %}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-7 control-label">A postscript about your child. And, if you have an SNS that can contact, fill in</div>
                        <div class="col-md-5">{% bootstrap_field form.note %}</div>
                    </div>
                    <div>
                        <input type="checkbox" name="service_terms_policy" class="service_terms_policy">
                        <a href="">Service, Terms and Privacy Policy</a>
                    </div>
                    <div class="alert alert-danger alert-service-term display-none">
                        <strong>You must agreed with our service, terms and privacy policy! </strong>
                    </div>
                    <div class="text-center confirm-btn-box">
                        <button type="submit" class="btn btn-secondary">Reserve here</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="alert alert-info display-none alert-nursery-full">
            <h4 class="text-center">Nursery is full for that day! You can reserve on another day or find another nursery</h4>
        </div>
    </div>
{% endblock %}


{% block javascript %}
    <script>
        $(document).ready(function () {
            setAvailableStock()
            setAvailableDateTime()
            setPeriod()
            setTotalPrice()

            $('#id_price_plan').change(function () {
                setPeriod()
                setTotalPrice()
            })

            $('#id_child_number').keyup(function () {
                setTotalPrice()
            })

            $('.js-start-date').change(function () {
                $('.reservation-info').show();
                $('.alert-nursery-full').hide();
                setAvailableStock()
                setAvailableDateTime()
            })

        })

        function setAvailableStock() {
            let target_date = $('.js-start-date').val();
            let nursery_id = $('#nursery_id').val()
            $.ajax({
                url: 'ajax/stock_per_date',
                data: {
                    'nursery_id': nursery_id,
                    'target_date': target_date
                },
                dataType: 'json',
                success: function (data) {
                    {#console.log(data.stock)#}
                    $('.js-available-stock').text(data.stock)
                    if (data.stock < 1 ) {
                        $('.reservation-info').hide();
                        $('.alert-nursery-full').show();
                    }
                }
            });
        }

        function setAvailableDateTime() {
            let target_date = $('.js-start-date').val();
            let nursery_id = $('#nursery_id').val()
            $.ajax({
                url: 'ajax/available-time-per-date',
                data: {
                    'nursery_id': nursery_id,
                    'target_date': target_date
                },
                contentType: "application/json",
                dataType: 'json',
                success: function (data) {
                    let time_choices = [
                        {'val': '0', 'label': '00:00'},
                        {'val': '1', 'label': '01:00'},
                        {'val': '2', 'label': '02:00'},
                        {'val': '3', 'label': '03:00'},
                        {'val': '4', 'label': '04:00'},
                        {'val': '5', 'label': '05:00'},
                        {'val': '6', 'label': '06:00'},
                        {'val': '7', 'label': '07:00'},
                        {'val': '8', 'label': '08:00'},
                        {'val': '9', 'label': '09:00'},
                        {'val': '10', 'label': '10:00'},
                        {'val': '11', 'label': '11:00'},
                        {'val': '12', 'label': '12:00'},
                        {'val': '13', 'label': '13:00'},
                        {'val': '14', 'label': '14:00'},
                        {'val': '15', 'label': '15:00'},
                        {'val': '16', 'label': '16:00'},
                        {'val': '17', 'label': '17:00'},
                        {'val': '18', 'label': '18:00'},
                        {'val': '19', 'label': '19:00'},
                        {'val': '20', 'label': '20:00'},
                        {'val': '21', 'label': '21:00'},
                        {'val': '22', 'label': '22:00'},
                        {'val': '23', 'label': '23:00'},
                    ]

                    let limits = JSON.parse(data.limit)

                    let options = ''
                    $.each(time_choices, function (idx, time_choice) {
                        let disabled = ''
                        let css_class=''
                        time_choice_value = parseInt(time_choice.val)
                        $.each(limits, function (idx, limit) {
                            time_from_value = parseInt(limit.time_from)
                            time_to_value = parseInt(limit.time_to)
                            if (time_choice_value >= time_from_value && time_choice_value <= time_to_value) {
                                disabled = 'disabled'
                                css_class = 'disabled'
                                return
                            }
                        })

                        options += "<option " + disabled + ">" + time_choice.label + "</option>"
                    })

                    let start_time_elem = $('.js-start-time')
                    start_time_elem.empty()
                    start_time_elem.append(options)
                }
            });
        }

        function setPeriod() {
            let period = $('#id_price_plan').children("option:selected").text()
            $('#period').val(period)
        }

        function setTotalPrice() {
            let unit_price = parseInt($('#id_price_plan').children("option:selected").val())
            let amount = $('#id_child_number').val() !== '' ? parseInt($('#id_child_number').val()) : 1
            let total_price = unit_price * amount

            $('.total-price-box .price').text(total_price)
            $('#total_price').val(total_price)
        }

        function goNext() {
            let stock = parseInt($('.js-available-stock').text())
            let child_number = parseInt($('#id_child_number').val())
            if (child_number > stock) {
                $('.alert-stock-exceed').show()
                return false
            }
            let agreed = $('.service_terms_policy').is(':checked')
            if (!agreed) {
                $('.alert-service-term').show()
                return false
            }
        }
    </script>
{% endblock %}